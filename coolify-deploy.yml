# Coolify 部署配置文件
# 此文件定義了在Coolify平台上部署全端應用程式的配置

version: '3.8'

services:
  # PostgreSQL 資料庫服務
  database:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: casino
      POSTGRES_USER: app_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app_user -d casino"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # 後端 API 服務
  backend:
    image: ${BACKEND_IMAGE:-billyziiii/fullstack-docker-app-backend:latest}
    environment:
      NODE_ENV: production
      PORT: 5000
      DATABASE_URL: postgresql://app_user:${POSTGRES_PASSWORD}@database:5432/casino
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGIN: ${FRONTEND_URL}
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # 前端應用服務
  frontend:
    image: ${FRONTEND_IMAGE:-billyziiii/fullstack-docker-app-frontend:latest}
    environment:
      VITE_API_URL: ${BACKEND_URL}/api
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local

# Coolify 特定配置
x-coolify:
  # 服務配置
  services:
    frontend:
      domains:
        - ${FRONTEND_DOMAIN}
      port: 2222  # 修改為使用端口 2222
      proxy:
        type: traefik
        ssl: true
        redirect_to_https: true
    
    backend:
      domains:
        - ${BACKEND_DOMAIN}
      port: 5000
      proxy:
        type: traefik
        ssl: true
        redirect_to_https: true
        path_prefix: /api

  # 環境變數配置
  environment:
    # 必需的環境變數
    required:
      - POSTGRES_PASSWORD
      - JWT_SECRET
      - FRONTEND_DOMAIN
      - BACKEND_DOMAIN
      - FRONTEND_URL
      - BACKEND_URL
    
    # 可選的環境變數
    optional:
      - FRONTEND_IMAGE
      - BACKEND_IMAGE

  # 資源限制
  resources:
    database:
      memory: 512M
      cpu: 0.5
    backend:
      memory: 256M
      cpu: 0.3
    frontend:
      memory: 128M
      cpu: 0.2

  # 備份配置
  backup:
    database:
      enabled: true
      schedule: "0 2 * * *"  # 每天凌晨2點
      retention: 30  # 保留30天
      
  # 監控配置
  monitoring:
    enabled: true
    healthchecks: true
    logs:
      retention: 7d  # 日誌保留7天